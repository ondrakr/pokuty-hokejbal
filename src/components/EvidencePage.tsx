'use client';

import { useState, useEffect } from 'react';
import { Hrac, Pokuta, HracSPokutami } from '../../types';
import HraciSeznam from './HraciSeznam';
import CenikPokut from './CenikPokut';
import PridatPokutu from './PridatPokutu';
import MobileHeader from './MobileHeader';
import MobilePlayerCard from './MobilePlayerCard';
import PlatebniModal from './PlatebniModal';

interface Props {
  initialHraci: HracSPokutami[];
  initialPokuty: Pokuta[];
  isLoggedIn?: boolean;
}

export default function EvidencePage({ initialHraci, initialPokuty, isLoggedIn = false }: Props) {
  const [hraci] = useState<Hrac[]>(initialHraci.map(h => ({ id: h.id, jmeno: h.jmeno, role: h.role, email: h.email })));
  const [pokuty] = useState<Pokuta[]>(initialPokuty);
  const [hraciSPokutami, setHraciSPokutami] = useState<HracSPokutami[]>(initialHraci);
  const [showPriceList, setShowPriceList] = useState(false);
  const [platebniModal, setPlatebniModal] = useState<{
    isOpen: boolean;
    hrac: Hrac | null;
    zbyva: number;
  }>({
    isOpen: false,
    hrac: null,
    zbyva: 0
  });

  // Data u≈æ m√°me p≈ôipraven√° z API, nemus√≠me nic p≈ôepoƒç√≠t√°vat
  useEffect(() => {
    setHraciSPokutami(initialHraci);
  }, [initialHraci]);

  // Funkce pro obnoven√≠ dat po p≈ôid√°n√≠ pokuty
  const handlePokutaPridana = () => {
    // Znovu naƒçteme data ze serveru
    window.location.reload();
  };

  // Funkce pro obnovƒõn√≠ dat po platbƒõ
  const handleDataChange = () => {
    window.location.reload();
  };

  // Funkce pro otev≈ôen√≠ platebn√≠ho mod√°lu
  const openPlatebniModal = (hrac: Hrac, zbyva: number) => {
    setPlatebniModal({
      isOpen: true,
      hrac,
      zbyva
    });
  };

  const closePlatebniModal = () => {
    setPlatebniModal({
      isOpen: false,
      hrac: null,
      zbyva: 0
    });
  };

  // Filtrujeme a se≈ôad√≠me hr√°ƒçe
  const filteredHraci = isLoggedIn 
    ? hraciSPokutami 
    : hraciSPokutami.filter(hrac => hrac.pokuty.length > 0); // Nep≈ôihl√°≈°en√Ωm pouze hr√°ƒçe s pokutami
  
  console.log('üîç EvidencePage - isLoggedIn:', isLoggedIn);
  console.log('üîç EvidencePage - v≈°ichni hr√°ƒçi:', hraciSPokutami.length);
  console.log('üîç EvidencePage - filtrovan√≠ hr√°ƒçi:', filteredHraci.length);
  
  const sortedHraci = [...filteredHraci].sort((a, b) => b.zbyva - a.zbyva);

  return (
    <>
      {/* Mobile Header - shown only on mobile */}
      <div className="lg:hidden">
        <MobileHeader title={isLoggedIn ? "Pokuty Junio≈ôi - Admin" : "Pokuty Junio≈ôi"} />
      </div>

      {/* Mobile Layout */}
      <div className="lg:hidden bg-gray-100 min-h-screen">
        {/* Mobile Stats Card */}
        <div className="p-4">
          <div className="bg-white rounded-xl shadow-md p-4 mb-4">
            <h2 className="font-bold text-gray-800 mb-3 text-center">üìä P≈ôehled t√Ωmu</h2>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div>
                <div className="text-xs text-gray-500 mb-1">Celkem</div>
                <div className="font-bold text-gray-900">
                  {hraciSPokutami.reduce((sum, hrac) => sum + hrac.celkovaCastka, 0)} Kƒç
                </div>
              </div>
              <div>
                <div className="text-xs text-gray-500 mb-1">Zaplaceno</div>
                <div className="font-bold text-green-600">
                  {hraciSPokutami.reduce((sum, hrac) => sum + hrac.zaplaceno, 0)} Kƒç
                </div>
              </div>
              <div>
                <div className="text-xs text-gray-500 mb-1">Zb√Ωv√°</div>
                <div className="font-bold text-red-600">
                  {hraciSPokutami.reduce((sum, hrac) => sum + hrac.zbyva, 0)} Kƒç
                </div>
              </div>
            </div>
          </div>

          {/* Mobile Action Buttons */}
          {isLoggedIn ? (
            <div className="grid grid-cols-2 gap-3 mb-4">
              <PridatPokutu hraci={hraci} onPokutaPridana={handlePokutaPridana} />
              <button
                onClick={() => setShowPriceList(true)}
                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg flex items-center gap-3 shadow-lg justify-center"
              >
                üìã Cen√≠k
              </button>
            </div>
          ) : (
            <div className="mb-4">
              <button
                onClick={() => setShowPriceList(true)}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg flex items-center gap-3 shadow-lg justify-center"
              >
                üìã Cen√≠k pokut
              </button>
            </div>
          )}

          {/* Mobile Player Cards */}
          <div className="space-y-4">
            <div className="flex justify-between items-center mb-3">
              <h2 className="font-bold text-gray-800 text-lg">
                üë• {isLoggedIn ? `Seznam hr√°ƒç≈Ø (${sortedHraci.length})` : `Hr√°ƒçi s pokutami (${sortedHraci.length})`}
              </h2>
              {!isLoggedIn && (
                <div className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                  üìñ Pouze prohl√≠≈æen√≠
                </div>
              )}
            </div>
            {sortedHraci.map((hrac) => (
              <MobilePlayerCard
                key={hrac.id}
                hrac={hrac}
                onOpenPayment={isLoggedIn ? openPlatebniModal : undefined}
                readOnly={!isLoggedIn}
              />
            ))}
          </div>
        </div>

        {/* Mobile Price List Modal */}
        {showPriceList && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
            <div className="bg-white w-full rounded-t-xl max-h-[80vh] overflow-y-auto">
              <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                <h3 className="text-lg font-bold">üìã Cen√≠k pokut</h3>
                <button
                  onClick={() => setShowPriceList(false)}
                  className="text-gray-400 hover:text-gray-600 text-xl"
                >
                  ‚úï
                </button>
              </div>
              <div className="p-4">
                <CenikPokut />
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Desktop Layout - hidden on mobile */}
      <div className="hidden lg:block">
        <div className="px-3">
          {/* Desktop Header s informac√≠ o re≈æimu */}
          <div className="mb-6 flex justify-between items-center">
            {isLoggedIn ? (
              <div className="text-center flex-1">
                <PridatPokutu hraci={hraci} onPokutaPridana={handlePokutaPridana} />
              </div>
            )}
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            {/* Lev√Ω sloupec - Cen√≠k pokut */}
            <div className="lg:col-span-1">
              <CenikPokut />
            </div>
            
            {/* Prav√Ω sloupec - Seznam hr√°ƒç≈Ø */}
            <div className="lg:col-span-2">
              <HraciSeznam hraci={hraciSPokutami} onDataChange={handleDataChange} readOnly={!isLoggedIn} />
            </div>
          </div>
        </div>
      </div>

      {/* Platebn√≠ mod√°l - pro oba layouty */}
      <PlatebniModal
        isOpen={platebniModal.isOpen}
        onClose={closePlatebniModal}
        hrac={platebniModal.hrac}
        zbyva={platebniModal.zbyva}
        onPlatbaProvedena={handleDataChange}
      />
    </>
  );
}
